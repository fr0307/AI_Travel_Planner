# AI旅行规划师 - 技术架构文档

## 技术栈详细说明

### 前端技术栈

#### Vue 3 + Vite + TypeScript
- **Vue 3**：采用Composition API，提供更好的逻辑复用和类型推断
- **Vite**：快速的开发服务器和构建工具，支持热重载
- **TypeScript**：增强代码类型安全，提高开发效率

#### UI组件库选择
- **Naive UI**：原生支持Vue 3，组件丰富且设计现代
- **TailwindCSS**：用于自定义样式和响应式设计
- **Element Plus**：备选方案，生态成熟

#### 状态管理
- **Pinia**：Vue官方推荐的状态管理库，轻量且类型安全

#### 路由管理
- **Vue Router 4**：支持路由守卫、懒加载等高级功能

### 后端技术栈

#### Node.js + Express/Fastify
- **Node.js**：JavaScript运行时，全栈开发一致性
- **Express.js**：成熟的Web框架，中间件生态丰富
- **Fastify**：高性能备选方案，适合高并发场景

#### 数据库与认证
- **Supabase**：完整的后端即服务(BaaS)
  - PostgreSQL数据库
  - 实时订阅功能
  - 用户认证系统
  - 文件存储服务

### 第三方服务集成

#### 语音识别 - 科大讯飞
- **iFlytek Web API**：支持中文语音识别，准确率高
- **实时语音转文字**：支持流式传输
- **语音合成**：可选功能，用于语音反馈

#### 地图服务 - 高德地图
- **JS API**：提供地图展示、POI搜索、路径规划
- **地理编码**：地址与坐标转换
- **地点标记**：行程地点可视化

#### AI服务 - 多提供商支持
- **OpenAI GPT-4**：行程规划和预算分析
- **阿里通义千问**：国内备选方案
- **百度文心一言**：国内备选方案

## 系统架构设计

### 整体架构图
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用      │    │   后端API       │    │  第三方服务     │
│   (Vue 3)       │    │   (Node.js)     │    │                 │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │  语音输入   │◄─────┤ │ 语音识别API │◄─────┤ │ 科大讯飞    │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │  地图展示   │◄─────┤ │ 地图服务API │◄─────┤ │ 高德地图    │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ AI行程规划  │◄─────┤ │  AI服务API  │◄─────┤ │ OpenAI等    │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ 数据同步    │◄─────┤ │ Supabase   │◄─────┤ │ 云端数据库  │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 前端架构详细设计

#### 组件结构
```
src/
├── components/           # 通用组件
│   ├── common/          # 基础组件
│   ├── layout/          # 布局组件
│   └── ui/              # UI组件
├── views/               # 页面组件
│   ├── auth/            # 认证页面
│   ├── dashboard/       # 仪表盘
│   ├── trip-planner/    # 行程规划
│   └── expense/         # 费用管理
├── composables/         # 组合式函数
│   ├── useSpeech.ts     # 语音功能
│   ├── useMap.ts        # 地图功能
│   ├── useAI.ts         # AI功能
│   └── useSupabase.ts   # 数据操作
├── stores/              # 状态管理
│   ├── auth.ts          # 认证状态
│   ├── trip.ts          # 行程状态
│   └── ui.ts            # UI状态
├── services/            # 服务层
│   ├── api/             # API调用
│   ├── speech/          # 语音服务
│   └── map/             # 地图服务
└── utils/               # 工具函数
    ├── constants.ts     # 常量定义
    └── helpers.ts       # 辅助函数
```

#### 核心组件说明

**语音输入组件 (VoiceInput.vue)**
```typescript
// 功能：语音识别输入
// 特性：实时转文字、可视化波形、错误处理
// 集成：科大讯飞Web API
```

**地图展示组件 (TripMap.vue)**
```typescript
// 功能：行程地点可视化
// 特性：标记点、路径绘制、信息窗口
// 集成：高德地图JS API
```

**行程规划组件 (ItineraryPlanner.vue)**
```typescript
// 功能：AI生成行程
// 特性：多日规划、拖拽调整、实时预览
// 集成：OpenAI API
```

### 后端架构详细设计

#### 目录结构
```
backend/
├── src/
│   ├── controllers/     # 控制器层
│   ├── services/        # 业务逻辑层
│   ├── models/          # 数据模型
│   ├── middleware/      # 中间件
│   ├── routes/          # 路由定义
│   ├── utils/           # 工具函数
│   └── config/          # 配置管理
├── tests/               # 测试文件
└── package.json
```

#### 核心服务模块

**语音识别服务 (speechService.js)**
```javascript
// 功能：处理语音识别请求
// 集成：科大讯飞API封装
// 特性：流式处理、错误重试、结果缓存
```

**AI行程服务 (aiService.js)**
```javascript
// 功能：调用AI生成行程规划
// 集成：OpenAI/通义千问API
// 特性：提示词工程、结果格式化、费用估算
```

**地图服务 (mapService.js)**
```javascript
// 功能：地理位置相关操作
// 集成：高德地图API
// 特性：POI搜索、路径规划、地理编码
```

## 数据流设计

### 语音识别流程
```
用户语音输入 → 前端录音 → 流式传输 → 后端语音识别API → 文字结果 → 前端显示
```

### 行程规划流程
```
用户输入参数 → 前端收集 → API请求 → AI服务处理 → 结构化结果 → 前端渲染
```

### 数据同步流程
```
前端操作 → Pinia状态更新 → Supabase实时订阅 → 多端同步 → 状态一致性
```

## 安全设计

### 认证安全
- JWT token认证机制
- Token自动刷新
- 路由守卫保护
- 敏感操作二次验证

### 数据安全
- 数据库字段加密
- API请求参数验证
- SQL注入防护
- XSS攻击防护

### 第三方服务安全
- API密钥环境变量管理
- 请求频率限制
- 错误信息脱敏

## 性能优化策略

### 前端优化
- 组件懒加载
- 图片压缩和懒加载
- API请求合并
- 本地缓存策略

### 后端优化
- 数据库查询优化
- API响应缓存
- 异步任务处理
- 连接池管理

### 第三方服务优化
- 请求结果缓存
- 失败重试机制
- 服务降级策略

## 错误处理设计

### 前端错误处理
- 全局错误捕获
- 用户友好提示
- 错误日志记录
- 自动恢复机制

### 后端错误处理
- 统一错误响应格式
- 详细错误日志
- 监控告警系统
- 优雅降级处理

## 监控和日志

### 前端监控
- 性能指标收集
- 用户行为分析
- 错误追踪
- 实时用户反馈

### 后端监控
- API响应时间监控
- 数据库性能监控
- 第三方服务状态监控
- 系统资源监控

## 部署架构

### 开发环境
```
本地开发 → Vite开发服务器 → 本地后端服务 → 第三方服务沙箱环境
```

### 生产环境
```
Docker容器 → Nginx负载均衡 → 后端集群 → 云端数据库 → CDN静态资源
```

### Docker配置
```yaml
# docker-compose.yml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    
  backend:
    build: ./backend
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
```

## 开发规范

### 代码规范
- ESLint + Prettier代码格式化
- TypeScript严格模式
- Git提交规范
- 代码审查流程

### 测试规范
- 单元测试覆盖率 > 80%
- 集成测试覆盖核心流程
- E2E测试关键用户路径
- 性能测试定期执行

## 技术债务管理

### 已知技术债务
- 第三方服务依赖风险
- 国际化支持待完善
- 移动端适配优化
- 离线功能扩展

### 技术演进计划
- 微服务架构迁移
- 边缘计算部署
- AI模型本地化
- 多语言支持扩展

---

**文档版本**：v1.0  
**创建日期**：2024年  
**最后更新**：2024年  
**维护团队**：技术架构组